import org.apache.tools.ant.filters.ReplaceTokens

plugins {
    id 'org.sonarqube' version '2.6.1'
    id 'distribution'
    id 'maven'
}

group 'de.maibornwolff.codecharta'
version = currentVersion

repositories {
    mavenCentral()
}

allprojects {
    group 'de.maibornwolff.codecharta'
    version = currentVersion

    repositories.addAll(rootProject.getBuildscript().getRepositories())

    apply plugin: 'jacoco'
    apply plugin: 'maven'

    jacoco {
        toolVersion = "0.7.8"
    }
}

distributions {
    main {
        baseName = 'codecharta-analysis'
        contents {
            from { 'README.md' }
            from('src/main/dist') {
                filter(ReplaceTokens, tokens: [
                        'cc_version': currentVersion,
                ])
            }
            subprojects {
                from tasks.withType(Tar)
            }
        }
    }
}

sonarqube {
    properties {
        property 'sonar.coverage.exclusions', '**/model/**, **/*Main*'
    }
}

task integrationTest(type: Exec) {
    executable 'sh'
    workingDir('test')
    args '-c', "./golden_test.sh $version"
}

integrationTest.dependsOn build
